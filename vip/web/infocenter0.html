<script>
let phone_sign = function() {
    if (window.localStorage.u) {
        let u = JSON.parse(window.localStorage.u)
        Sea.Ajax({
            url: 'http://li-flower.com:8001/infocenter',
            data: u,
        }).then(res => {
            let data = JSON.parse(res)
            if (data.ok) {
                let o = data.data
                Sea.form = Object.assign({}, o, Sea.form)
                $('#u-phone').text(o.phone)
                $('#u-name').val(o.name || '')
                $('#loc_province').select2('data').text = o.province
                $('#select2-chosen-1').text(o.province)
                $('#loc_city').select2('data').text = o.city
                $('#select2-chosen-2').text(o.city)
                $('#loc_town').select2('data').text = o.town
                $('#select2-chosen-3').text(o.town)

                $('.sign-sex btn').each(function(i, e) {
                    if (e.innerText == o.sex) {
                        this.style.background = '#141414'
                        this.style.color = 'white'
                    } else {
                        this.style = ''
                    }
                })
            } else {
                alert('登录失败，请重新登陆')
                window.location = '/sign-in'
            }
        })
    } else {
        alert('登录失败，请重新登陆')
        window.location = '/sign-in'
    }
}
let wx_sign = function() {
    if (window.localStorage.state) {
        let arr = window.location.search.slice(1).split('&')
        let o = {}
        for (let e of arr) {
            let a = e.split('=')
            let key = a[0]
            let val = a[1]
            o[key] = val
        }
        if (o.state === window.localStorage.state) {
            Sea.Ajax({
                url: 'http://li-flower.com:8001/wx_api/sign_in',
                data: {
                    code: o.code,
                }
            }).then(res => {
                let data = JSON.parse(res)
                Sea.Ajax({
                    url: 'http://li-flower.com:8001/wx_api/userinfo',
                    data: {
                        access_token: data.access_token,
                        openid: data.openid,
                    }
                }).then(res => {
                    let data = JSON.parse(res)
                    $('#u-head')[0].src = data.headimgurl
                    $('#u-name')[0].value = data.nickname
                    $('#u-phone')[0].innerText = data.nickname
                    Sea.form = Object.assign({}, data, Sea.form)
                    let temp = {
                        '1': '先生',
                        '2': '女士',
                    }
                    data.sex = temp[data.sex]
                    $('.sign-sex btn').each(function(i, e) {
                        if (e.innerText == data.sex) {
                            this.style.background = '#141414'
                            this.style.color = 'white'
                        } else {
                            this.style = ''
                        }
                    })
                    // 微信注册
                    Sea.Ajax({
                        url: 'http://li-flower.com:8001/user_sign_up',
                        data: {
                            wx: data,
                        }
                    }).then(res => {
                        log(res)
                    })
                })
            })
        } else {
            phone_sign()
        }
    } else {
        phone_sign()
    }
}
wx_sign()
</script>
